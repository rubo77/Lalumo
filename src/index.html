<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lalumo</title>
  <link rel="icon" href="./favicon.ico" sizes="any" />
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./images/logo_bird_sings.jpg" />
  <!-- Native App Detector - Setzt das window.isNativeApp Flag für zuverlässige App-Erkennung -->
  <script>
    // In der nativen App wird capacitorJs geladen
    // Dies ist ein zuverlässiger Indikator, dass wir in einer nativen App laufen
    window.isNativeApp = (typeof window.Capacitor !== 'undefined');
    console.log('Native app environment detected:', window.isNativeApp);
  </script>
  <style>
    /* Critical CSS for initial rendering */
    body {
      font-family: sans-serif;
      margin: 0; padding: 0;
      background-image: url('./images/x.gif');
      background-size: contain;
      background-position: top left;
    }
    
    /* Loading spinner styles */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-in-out;
    }
    
    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    #loading-logo {
      width: 150px;
      height: 150px;
      margin-bottom: 20px;
    }
    
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    body {
      background-repeat: no-repeat;
    }
    .container { width: 100%; max-width: 100%; overflow-x: hidden; min-height: 100%; }
    /* Main app container only - activity pages */
    main.container { min-height: 100vh; }
    
    /* Modal styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                    background-color: rgba(0,0,0,0.7); z-index: 1000; 
                    display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: white; border-radius: 10px; padding: 20px; 
                    max-width: 90%; width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    /* Menu styles */
    .menu-open { width: 250px; }
    
    /* Button styles */
    .primary-button { display: inline-block; padding: 10px 16px; background-color: #4a86e8; 
                     color: white; border: none; border-radius: 5px; cursor: pointer; }
    .button { display: inline-block; padding: 8px 12px; border-radius: 5px; }
    
    /* Activity elements */
    .activity-container { padding: 12px; }
    .mascot-welcome { display: flex; align-items: center; margin: 10px 0; }
  </style>
  <!-- Scripts and more styles will be injected by webpack -->
  <!-- Cache busting wird durch webpack erledigt -->
  
</head>
<body class="loading">
  <!-- Portrait Mode Notice -->
  <div class="portrait-notice">
    <h2>📱 Bitte drehe dein Gerät</h2>
    <p>Lalumo funktioniert am besten im Hochformat.</p>
    <p>Please rotate your device to portrait mode.</p>
  </div>
  
  <!-- Loading spinner overlay -->
  <div id="loading-overlay">
    <img id="loading-logo" src="./icons/icon-512.png" alt="Lalumo Logo">
    <div class="spinner"></div>
  </div>
  
  <script>
    // Set initial environment classes
    document.body.classList.add(
      window.isNativeApp ? 'native-app' : 'web-app',
      window.isAndroid ? 'android' : (window.isiOS ? 'ios' : 'desktop'),
      !window.isNativeApp && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'dev-mode' : 'production'
    );

    // Hide loading overlay when page is fully loaded
    window.addEventListener('load', function() {
      setTimeout(function() {
        document.getElementById('loading-overlay').classList.add('hidden');
        document.body.classList.remove('loading');
      }, 50); // small delay for smoother transition
    });
  </script>
  <!-- app.js -->
  <main id="app" x-data="app()" x-init="init(); initLazyLoading(); updateEnvironmentClasses();" @click="unlockAudio()" @touchstart="unlockAudio()" class="container">
    
    <!-- Username Prompt Modal -->
    <div class="modal-overlay" x-show="showUsernamePrompt" x-transition style="display: none;">
      <div class="modal-content" @click.outside="setUsername()">
        <h3 x-text="$store.strings?.welcome_message || 'Welcome to Lalumo!'"></h3>
        <p x-text="$store.strings?.create_name_message || 'Let\'s create a special name just for you!'"></p>
        <button class="primary-button" @click="setUsername()" x-text="$store.strings?.button_generate_name || 'Generate Random Name'"></button>
        <div class="modal-footer">
          <p class="note" x-text="$store.strings?.progress_saved_message || 'Your progress will be saved automatically'"></p>
        </div>
      </div>
    </div>

    <!-- Hamburger Menu -->
    <div class="hamburger-container" :class="{ 'menu-open': menuOpen, 'desktop-menu': window.innerWidth >= 1024, 'menu-locked': menuLocked }" x-init="window.innerWidth >= 1024 ? menuOpen = true : menuOpen = false; window.addEventListener('resize', () => { if(window.innerWidth >= 1024) menuOpen = true; })">
      <!-- Hamburger button with conditional click handler based on lock state -->
      <button class="hamburger-button" @click="menuLocked ? null : menuOpen = !menuOpen">
        <div class="hamburger-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
      
      <!-- Child Lock button with progress indicator -->
      <button class="menu-lock-button" 
        :class="{ 'locked': menuLocked }"
        @mousedown="startLongPressUnlock" 
        @mouseup="cancelLongPressUnlock" 
        @mouseleave="cancelLongPressUnlock"
        @touchstart="startLongPressUnlock" 
        @touchend="cancelLongPressUnlock" 
        @touchcancel="cancelLongPressUnlock">
        <div class="lock-icon-container">
          <div class="lock-progress-indicator" x-show="menuLocked"></div>
          <div class="lock-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4zm0 10c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z" x-show="menuLocked"/>
              <path d="M12 1C8.676 1 6 3.676 6 7v2h4V7c0-1.104.896-2 2-2s2 .896 2 2v2h4V7c0-3.324-2.676-6-6-6zm0 20c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-9H6v8h12v-8z" x-show="!menuLocked"/>
            </svg>
          </div>
        </div>
        <span class="lock-hint" x-show="menuLocked" x-text="$store.strings?.menu_unlock_hint || 'Halte 3 Sek. gedrückt zum Entsperren'"></span>
      </button>
      
      <!-- Menu content -->
      <div class="menu-content" x-show="menuOpen" @click.away="window.innerWidth < 1024 ? menuOpen = false : null" x-transition>
        
        <div class="menu-chapters">
          <!-- pitches -->
          <button @click="active = 'pitches'; $dispatch('set-activity-mode', 'main')" :class="{ 'active': active === 'pitches' }">
            <span x-text="$store.strings?.menu_pitches || 'Pitches & Melodies'"></span>
          </button>
        </div>
        
        <!-- Activities Section (shows only when Pitches chapter is active) -->
        <template x-if="active === 'pitches'">
          <div class="menu-activities">
            <!-- High or Low -->
            <button id="nav_1_1"
              @click="$dispatch('set-activity-mode', {component: 'pitches', mode: '1_1_pitches_high_or_low'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'pitches' && value.mode === '1_1_pitches_high_or_low')"
              :class="{ 'active': isActive }"
              style="display: auto;"
            >
              🔊 <span x-text="$store.strings?.high_or_low || 'High or Low?'"></span>
            </button>

            <!-- Up or Down -->
            <button id="nav_1_2"
              @click="$dispatch('set-activity-mode', {component: 'pitches', mode: '1_2_pitches_match-sounds'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'pitches' && value.mode === '1_2_pitches_match-sounds')"
              :class="{ 'active': isActive }"
            >
            🎵 <span x-text="$store.strings?.match_sounds || 'Up or Down'"></span>
            </button>
            
            <!-- Does it sound right -->
            <button id="nav_1_4"
              @click="$dispatch('set-activity-mode', {component: 'pitches', mode: '1_4_pitches_does-it-sound-right'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'pitches' && value.mode === '1_4_pitches_does-it-sound-right')"
              :class="{ 'active': isActive }">
              👉 <span x-text="$store.strings?.does_it_sound_right || 'Does It Sound Right?'"></span>
            </button>
            
            <!-- Memory Game -->
            <button id="nav_1_5"
              @click="$dispatch('set-activity-mode', {component: 'pitches', mode: '1_5_pitches_memory-game'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'pitches' && value.mode === '1_5_pitches_memory-game')"
              :class="{ 'active': isActive }">
              🎹 <span x-text="$store.strings?.memory_game || 'Memory Game'"></span>
            </button>

            <!-- following activities require unlock -->

            <!-- Locked Draw a Melody button (visible when not unlocked) -->
            <button id="nav_1_3_locked" x-show="!areAllActivitiesUnlocked"
              @click="active = 'referral-code'; window.innerWidth < 1024 ? menuOpen = false : null"
              class="locked-activity"
            >
              <span>🔒 ✏️ <span x-text="$store.strings?.draw_melody || 'Draw a Melody'"></span></span>
            </button>
            
            <!-- Unlocked Draw a Melody button (visible when unlocked through referrals) -->
            <button id="nav_1_3" x-show="areAllActivitiesUnlocked"
              @click="$dispatch('set-activity-mode', {component: 'pitches', mode: '1_3_pitches_draw-melody'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'pitches' && value.mode === '1_3_pitches_draw-melody')"
              :class="{ 'active': isActive }"
            >
              ✏️ <span x-text="$store.strings?.draw_melody || 'Draw a Melody'"></span>
            </button>
            
            <!-- Debug button for Draw a Melody (always visible) -->
            <button id="nav_1_3_debug" class="debug-element"
              @click="$dispatch('set-activity-mode', {component: 'pitches', mode: '1_3_pitches_draw-melody'}); window.innerWidth < 1024 ? menuOpen = false : null"
            >
              🔓 ✏️ <span x-text="$store.strings?.draw_melody || 'Draw a Melody'"></span>
            </button>
            
          </div>
        </template>

        <div class="menu-chapters">
          <!-- Regular chords button -->
          <button 
            @click="
              active = 'chords'; 
              $dispatch('set-activity-mode', {component: 'chords', mode: '2_2_chords_stable_unstable'});
              checkAndAutoCloseMenu();
            "
            :class="{ 'active': active === 'chords' }">
            <span x-text="$store.strings?.menu_chords || 'Chords'"></span>
          </button>
        </div>
        
        <!-- Activities for Chapter Chords -->
        <template x-if="active === 'chords'">
          <div class="menu-activities">
            <button id="nav_2_1"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_1_chords_color-matching'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_1_chords_color-matching')"
              :class="{ 'active': isActive }"
              class="debug-element"
            >
              🌈 <span x-text="$store.strings?.chord_color_matching || 'Color Matching'"></span>
            </button>
            <button id="nav_2_2"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_2_chords_stable_unstable'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_2_chords_stable_unstable')"
              :class="{ 'active': isActive }"
            >
              🏞️ <span x-text="$store.strings?.chords_stable_unstable || 'Stable or Unstable'"></span>
            </button>
            <button id="nav_2_3"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_3_chords_chord-building'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_3_chords_chord-building')"
              :class="{ 'active': isActive }"
              class="debug-element"
            >
              🧱 <span x-text="$store.strings?.chord_building || 'Chord Building'"></span>
            </button>
            <button id="nav_2_4"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_4_chords_missing-note'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_4_chords_missing-note')"
              :class="{ 'active': isActive }"
              class="debug-element"
            >
              🎼 <span x-text="$store.strings?.missing_note || 'Missing Note'"></span>
            </button>
            <!-- Locked version of Chord Story Characters (visible when not unlocked) -->
            <button id="nav_2_5_locked"
              x-show="!areAllActivitiesUnlocked"
              @click="active = 'referral-code'; window.innerWidth < 1024 ? menuOpen = false : null"
              class="locked-activity"
            >
              🔒 🎭 <span x-text="$store.strings?.chord_characters || 'Character Matching'"></span>
            </button>
            
            <!-- Unlocked version of Chord Story Characters (visible when unlocked through referrals) -->
            <button id="nav_2_5"
              x-show="areAllActivitiesUnlocked"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_5_chords_characters'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_5_chords_characters')"
              :class="{ 'active': isActive }"
            >
              🎭 <span x-text="$store.strings?.chord_characters || 'Character Matching'"></span>
            </button>
            
            <!-- Debug button for Chord Story Characters (always available) -->
            <button id="nav_2_5_debug"
              class="debug-element"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_5_chords_characters'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_5_chords_characters')"
              :class="{ 'active': isActive }"
            >
              Debug 🎭 <span x-text="$store.strings?.chord_characters || 'Character Matching'"></span>
            </button>
            <button id="nav_2_6"
              @click="$dispatch('set-activity-mode', {component: 'chords', mode: '2_6_chords_harmony-gardens'}); window.innerWidth < 1024 ? menuOpen = false : null"
              x-data="{ isActive: false }"
              x-init="$watch('$store.currentActivityMode', value => isActive = value && value.component === 'chords' && value.mode === '2_6_chords_harmony-gardens')"
              :class="{ 'active': isActive }"
              class="debug-element"
            >
              🌸 <span x-text="$store.strings?.harmony_gardens || 'Harmony Gardens'"></span>
            </button>
          </div>
        </template>
        
        <div class="menu-chapters">
          <!-- later -->
          <button @click="active = 'tonecolors'" :class="{ 'active': active === 'tonecolors' }"
          style="display: none;"
          >
            🎨 <span x-text="$store.strings?.menu_tonecolors || 'Tone Colors'"></span>
          </button>
          <button @click="active = 'rhythms'" :class="{ 'active': active === 'rhythms' }"
          style="display: none;"
          >
            ⏱️ <span x-text="$store.strings?.menu_rhythm || 'Rhythm'"></span>
          </button>
          <button @click="active = 'freeplay'" :class="{ 'active': active === 'freeplay' }"
          style="display: none;"
          >
            🎮 <span x-text="$store.strings?.menu_freeplay || 'Free Play'"></span>
          </button>
        </div>
        
        
        <!-- Flexible spacer to push settings and legal to bottom -->
        <div class="menu-spacer"></div>
        
        <!-- Settings Section -->
        <div class="menu-settings">
          
          <!-- Reset Current Activity Button -->
          <button @click="resetCurrentActivity()" class="menu-reset-btn" :title="$store.strings?.reset_current_activity || 'Reset Current Activity'" x-show="getCurrentActivityProgress() > 0">
            🔄 <span x-text="$store.strings?.reset_current_activity || 'Reset Current Activity'"></span>
          </button>
          
          <button @click="active = 'settings'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'settings' }" class="settings-button" x-show="username">
            <div class="user-avatar" x-show="username">
              <span x-text="username ? username.charAt(0) : '?'"></span>
            </div>
            ⚙️ <span class="settings-label" x-text="$store.strings?.player_settings || 'Player Settings'"></span>
          </button>
        </div>
        
        <!-- Legal Section -->
        <div class="menu-legal">
          <button @click="active = 'impressum'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'impressum' }">
            ℹ️ <span x-text="$store.strings?.menu_impressum || 'Impressum'"></span>
          </button>
          <button @click="active = 'datenschutz'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'datenschutz' }">
            🔒 <span x-text="$store.strings?.menu_datenschutz || 'Datenschutz'"></span>
          </button>
          <button @click="active = 'credits'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'credits' }">
            🏆 <span x-text="$store.strings?.menu_credits || 'Credits'"></span>
          </button>
          <button @click="active = 'referral-code'; window.innerWidth < 1024 ? menuOpen = false : null" :class="{ 'active': active === 'referral-code' }">
            <img src="images/share.png" alt="Share" style="height: 18px; vertical-align: middle; margin-right: 5px;"> <span x-text="$store.strings?.menu_share || 'Share'"></span>
          </button>
          <!-- Play Store Link - nur in Web-App anzeigen (nicht in Android oder iOS) -->
          <a x-show="!$store.isAndroidApp() && !$store.isIOSApp()" href="https://play.google.com/store/apps/details?id=com.lalumo.app" target="_blank" class="menu-button">
            <img src="images/get_on_playstore.png" alt="Play Store" style="height: 45px; vertical-align: middle; margin-right: 5px;">
          </a>
        </div>
      </div>
    </div>

    <!-- Chapter: Pitch Chapters View -->
    <section class="chapters-view" x-show="active === 'pitches'" x-transition>
      <div x-data="pitches()" x-init="init()">
        
        <!-- Main landing with clickable image -->
        <div x-show="!mode || mode === 'main'" class="pitch-landing">
          <div class="image-map-container">
            <div class="clickable-area match-area" @click="setMode('1_2_pitches_match-sounds')" aria-label="Match Mode">
              <span class="area-label" x-text="$store.strings?.match_sounds || 'Up or Down'"></span>
            </div>
            <div class="clickable-area draw-area" @click="setMode('1_3_pitches_draw-melody')" aria-label="Draw Mode">
              <span class="area-label" x-text="$store.strings?.draw_melody || 'Draw a Melody'"></span>
            </div>
            <div class="clickable-area memory-area" @click="setMode('1_5_pitches_memory-game')" aria-label="Memory Mode">
              <span class="area-label" x-text="$store.strings?.memory_game || 'Memory Game'"></span>
            </div>
          </div>

        </div>
        
        <!-- High or Low Activity -->
        <div id="1_1_pitches" x-show="mode === '1_1_pitches_high_or_low'" class="activity-container lazyload-bg" data-background-image="./images/backgrounds/pitches_action1_1_sloth_mouse.jpg" style="background-size: cover; background-position: top left;
        background-image: url('./images/backgrounds/pitches_action1_1_sloth_mouse.jpg');
        height: 100vh;
        width: 100%;
        background-size: 100% 100%;
        background-repeat: no-repeat;">
          
          <!-- Play button - bird in background -->
          <button class="circular-play-button" 
                  @click="playHighOrLowTone(); blurElement($event)" 
                  @touchstart.prevent @touchend.prevent="$el.click();"
                  :aria-label="$store.strings?.play_tone_a11y || 'Play tone'" 
                  :title="$store.strings?.play_tone_a11y || 'Play tone'">
          </button>
          
          <!-- High or Low choice buttons -->
          <div class="high-low-choices">
            <div class="pitch-card low-choice activity-button-blocker" 
                 @click="checkHighOrLowAnswer('low'); blurElement($event)" 
                 :aria-label="currentHighOrLowStage >= 3 ? ($store.strings?.second_tone_lower_a11y || 'The second tone is lower') : ($store.strings?.low_choice_a11y || 'Low tone')"
                 :title="currentHighOrLowStage >= 3 ? ($store.strings?.second_tone_lower_a11y || 'The second tone is lower') : ($store.strings?.low_choice_a11y || 'Low tone')">
              <div class="pitch-icon low-icon">
                <img src="images/x.gif" alt="Low pitch" />
                <span class="choice-label" 
                      x-text="currentHighOrLowStage >= 3 ? 
                        ($store.strings?.low_choice || 'Tiefer') : 
                        ($store.strings?.low_choice || 'Tief')"></span>
              </div>
            </div>
            <div class="pitch-card high-choice activity-button-blocker" 
                 @click="checkHighOrLowAnswer('high'); blurElement($event)" 
                 :aria-label="currentHighOrLowStage >= 3 ? ($store.strings?.second_tone_higher_a11y || 'The second tone is higher') : ($store.strings?.high_choice_a11y || 'High tone')"
                 :title="currentHighOrLowStage >= 3 ? ($store.strings?.second_tone_higher_a11y || 'The second tone is higher') : ($store.strings?.high_choice_a11y || 'High tone')">
              <div class="pitch-icon high-icon">
                <img src="images/x.gif" alt="High pitch" />
                <span class="choice-label" 
                      x-text="currentHighOrLowStage >= 3 ? 
                        ($store.strings?.high_choice || 'Höher') : 
                        ($store.strings?.high_choice || 'Hoch')"></span>
              </div>
            </div>
          </div>
          
          <!-- Progress display -->
          <div class="progress-display high-low-progress">
            <p x-text="($store.strings?.correct_answers_count || 'Correct answers: {0}').replace('{0}', progress['1_1'] || 0)"></p>
            <p x-show="(progress['1_1'] || 0) < 10" x-text="$store.strings?.high_low_stage1 || 'Get 10 correct to make the tones closer!'"></p>
            <p x-show="(progress['1_1'] || 0) >= 10 && (progress['1_1'] || 0) < 20" x-text="$store.strings?.high_low_stage2 || 'Get 20 correct to hear two tones!'"></p>
            <p x-show="(progress['1_1'] || 0) >= 20 && (progress['1_1'] || 0) < 30" x-text="$store.strings?.high_low_stage3 || 'Get 30 correct to make it harder!'"></p>
            <p x-show="(progress['1_1'] || 0) >= 30 && (progress['1_1'] || 0) < 40" x-text="$store.strings?.high_low_stage4 || 'Get 40 correct for the ultimate challenge!'"></p>
            <p x-show="(progress['1_1'] || 0) >= 40" x-text="$store.strings?.high_low_master || 'Master level achieved! :celebration:'"></p>
          </div>
          
          <!-- Feedback message -->
          <div x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
        </div>
                
        <!-- Matching Mode -->
        <div id="1_2_pitches" x-show="mode === '1_2_pitches_match-sounds'" class="activity-container lazyload-bg" data-background-image="./images/backgrounds/pitches_action1_2.jpg"
        style="background-size: cover; background-position: top left; background-image: 1s ease">
          
          <!-- Play button - only show when not in game mode -->
          <button x-show="!gameMode" class="circular-play-button" 
          @click="playCurrentMelody(); blurElement($event)" 
          @touchstart.prevent @touchend.prevent="$el.click();"
          aria-label="Start Game" title="Play">
          </button>
          
          <!-- Game mode play button - only show when in game mode -->
          <button x-show="gameMode" class="circular-play-button" 
          @click="playCurrentMelody(); blurElement($event)" 
          @touchstart.prevent @touchend.prevent="$el.click();"
          aria-label="Play Melody" title="Play">
          </button>

          <!-- Grid-Container für Match-Sounds mit richtigem rowspan-Verhalten -->
          <div class="match-sounds-container">
            <!-- Up pattern (immer sichtbar) - oben links -->
            <div class="pitch-card up-card activity-button-blocker" @click="checkMatch('up'); blurElement($event)" @mousedown="startLongPress('up')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()" @touchstart.prevent @touchend.prevent="$el.click();">
              <div class="pitch-icon up">
                <img src="images/1x1.gif" alt="Rocket going up" />
              </div>
            </div>
            
            <!-- Down pattern (immer sichtbar) - rechts mit möglichem rowspan -->
            <div class="pitch-card down-card activity-button-blocker" @click="checkMatch('down'); blurElement($event)" @mousedown="startLongPress('down')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()" @touchstart.prevent @touchend.prevent="$el.click();">
              <div class="pitch-icon down">
                <img src="images/1x1.gif" alt="Slide going down" />
              </div>
            </div>
            
            <!-- Wave pattern (wenn freigeschaltet) - unten links -->
            <div x-show="unlockedPatterns.includes('wave')" class="pitch-card wave-card activity-button-blocker" @click="checkMatch('wave'); blurElement($event)" @mousedown="startLongPress('wave')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()" @touchstart.prevent @touchend.prevent="$el.click();">
              <div class="pitch-icon wave">
                <img src="images/1x1.gif" alt="Wave pattern" />
              </div>
            </div>
            
            <!-- Jump pattern (wenn freigeschaltet) - unten rechts -->
            <div x-show="unlockedPatterns.includes('jump')" class="pitch-card jump-card activity-button-blocker" @click="checkMatch('jump'); blurElement($event)" @mousedown="startLongPress('jump')" @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()" @touchstart.prevent @touchend.prevent="$el.click();">
              <div class="pitch-icon jump">
                <img src="images/1x1.gif" alt="Jumping frog" />
              </div>
            </div>
          </div>
          
          <!-- Progress display -->
          <div x-show="mode === '1_2_pitches_match-sounds'" class="progress-display">
            <p x-text="($store.strings?.correct_answers_count || 'Correct answers: {0}').replace('{0}', correctAnswersCount)"></p>
            <p x-show="correctAnswersCount < 10" x-text="$store.strings?.unlock_wave_message || 'Get 10 correct to unlock wavy patterns! :wave:'"></p>
            <p x-show="correctAnswersCount >= 10 && correctAnswersCount < 20" x-text="$store.strings?.unlock_jump_message || 'Get 20 correct to unlock random patterns! ��'"></p>
            <p x-show="correctAnswersCount >= 20" x-text="$store.strings?.all_patterns_unlocked || 'All patterns unlocked! :celebration:'"></p>
          </div>
          
          <div x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
        </div>
        
        <!-- Drawing Mode -->
        <div id="1_3_pitches" x-show="mode === '1_3_pitches_draw-melody'" class="activity-container lazyload-bg" data-background-image="./images/backgrounds/pitches_action1_3.jpg">
          
          <div style="height:52vw"></div>

          <div class="drawing-container">
            <canvas class="drawing-canvas" width="600" height="300"
                   @mousedown="startDrawing" 
                   @mousemove="draw" 
                   @mouseup="endDrawing"
                   @touchstart="startDrawing" 
                   @touchmove="draw" 
                   @touchend="endDrawing">
            </canvas>
          </div>
        </div>
        
        <!-- Does It Sound Right? Activity -->
        <div id="1_4_pitches" x-show="mode === '1_4_pitches_does-it-sound-right'" class="activity-container lazyload-bg" data-background-image="./images/backgrounds/pitches_action1_4.jpg">

          <!-- Practice Mode -->
          <div class="practice-mode" x-show="!gameMode">
            <div class="center-container">
              <!-- Instrument Selection Buttons -->
              <div class="instrument-buttons">
                <!-- Violin Button -->
                <button class="instrument-button violin" @click="startSoundJudgmentGame('violin'); blurElement($event)" 
                  :title="$store.strings?.violin || 'Violin'" aria-label="Play with violin">
                  <div class="instrument-icon violin-icon">🎻</div>
                </button>
                
                <!-- Flute Button -->
                <button class="instrument-button flute" @click="startSoundJudgmentGame('flute'); blurElement($event)" 
                  :title="$store.strings?.flute || 'Flute'" aria-label="Play with flute">
                  <div class="instrument-icon flute-icon">🎵</div>
                </button>
                
                <!-- Double Bass Button -->
                <button class="instrument-button doublebass" @click="startSoundJudgmentGame('doublebass'); blurElement($event)"
                  :title="$store.strings?.doublebass || 'Double Bass'" aria-label="Play with doublebass">
                  <div class="instrument-icon doublebass-icon">🎻</div>
                </button>
              </div>
            </div>
            
            <!-- Start Game Mode Button (at the bottom) -->
            <div class="start-game-container">
              <button class="start-game-button" @click="startSoundJudgmentGame(); blurElement($event)" aria-label="Start Game" :title="$store.strings?.start_game || 'Start Game'">
                <span class="play-icon">▶</span>
              </button>
            </div>
          </div>

          <!-- Game Mode -->
          <div class="game-mode" x-show="gameMode">
            <!-- Play Melody Button -->
            <div class="melody-play-container">
              <button class="circular-play-button" @click="playCurrentMelody(); blurElement($event)" aria-label="Play Melody" title="Play Melody">
                
              </button>
              <div class="melody-name" x-show="currentMelodyName" x-text="currentMelodyName"></div>
              <!-- Next melody button -->
              <button class="next-melody-button" @click="playMelody(true); blurElement($event)" aria-label="Next melody" title="Next melody">
                <span style="font-size: 18px;">⏭</span>
              </button>
            </div>

            <!-- Animal choice buttons -->
            <div class="sound-judgment-options">
              <div class="pitch-card animal-card happy activity-button-blocker" @click="checkSoundHighOrLow(true); blurElement($event)" @touchstart.prevent @touchend.prevent="$el.click();" aria-label="Sounds good" title="Sounds good">
                <div class="pitch-icon animal-icon" title="Sounds good!">
                  <img src="images/1_5_pitches_good_cat.png" alt="Happy cat">
                </div>
              </div>
              <div class="pitch-card animal-card unhappy activity-button-blocker" @click="checkSoundHighOrLow(false); blurElement($event)" @touchstart.prevent @touchend.prevent="$el.click();" aria-label="Sounds wrong" title="Sounds wrong">
                <div class="pitch-icon animal-icon" title="Sounds wrong!">
                  <img src="images/1_5_pitches_bad_snake.png" alt="Unhappy snake">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Feedback message -->
          <div id="feedback_message_1_4_pitches" x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
          
        </div>
        
        <!-- Memory Mode -->
        <div id="1_5_pitches" x-show="mode === '1_5_pitches_memory-game'" class="activity-container lazyload-bg" data-background-image="./images/backgrounds/pitches_action1_5.jpg">
          <button class="circular-play-button" @click="playCurrentMelody(); blurElement($event)" aria-label="Play Melody" title="Play Melody"></button>

          
          <div class="piano-keyboard">
            <!-- White keys C, D, E, G, A with black key indicators -->
            <button class="piano-key white c4 activity-button-blocker" @click="addToSequence('C4')" @touchstart.prevent @touchend.prevent="$el.click();" :class="{ 'active': currentHighlightedNote === 'C4' }">C</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white d4 activity-button-blocker" @click="addToSequence('D4')" @touchstart.prevent @touchend.prevent="$el.click();" :class="{ 'active': currentHighlightedNote === 'D4' }">D</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white e4 activity-button-blocker" @click="addToSequence('E4')" @touchstart.prevent @touchend.prevent="$el.click();" :class="{ 'active': currentHighlightedNote === 'E4' }">E</button>
            <div class="piano-key inactive f4" aria-hidden="true">F</div>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white g4 activity-button-blocker" @click="addToSequence('G4')" @touchstart.prevent @touchend.prevent="$el.click();" :class="{ 'active': currentHighlightedNote === 'G4' }">G</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <button class="piano-key white a4 activity-button-blocker" @click="addToSequence('A4')" @touchstart.prevent @touchend.prevent="$el.click();" :class="{ 'active': currentHighlightedNote === 'A4' }">A</button>
            <div class="piano-key black" aria-hidden="true"></div>
            <div class="piano-key inactive b4" aria-hidden="true" x-text="$store.strings?.piano_key_b || 'B'"></div>
          </div>
          
          <div class="sequence-progress">
            <template x-for="(_, index) in userSequence" :key="index">
              <div class="progress-dot active"></div>
            </template>
            
            <template x-for="(_, index) in Array(Math.max(0, currentSequence.length - userSequence.length))" :key="index">
              <div class="progress-dot"></div>
            </template>
          </div>
          
          <div x-show="showFeedback" class="feedback-message" x-text="feedback"></div>
        </div>
      </div>
    </section>

    <!-- Chapter: Tone Colors -->
    <section class="chapters-view" x-show="active === 'tonecolors'" x-transition>
      <div x-data="tonecolors" x-init="init()">
        <h2>Discover Tone Colors</h2>
        <div class="tone-grid">
          <div class="tone-card" @click="pick('warm')">
            <div class="tone-icon warm"></div>
            <p>Warm</p>
          </div>
          <div class="tone-card" @click="pick('cold')">
            <div class="tone-icon cold"></div>
            <p>Cold</p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Chapter: Rhythm -->
    <section class="chapters-view" x-show="active === 'rhythms'" x-transition>
      <h2>Rhythm Exercises</h2>
      <p>Coming soon!</p>
    </section>
    
    <!-- Chapter: Chords -->
    <section class="chapters-view" x-show="active === 'chords'" x-transition class="chord-chapters-view lazyload-bg" data-background-image="./x.gif" style="background-size: cover; background-position: top center; border-radius: 0;">
      <div x-data="chords()" x-init="init()">
        
        <!-- Main chord activity selection screen -->
        <div x-show="!mode || mode === 'main'" class="chord-landing">
          <div class="image-map-container"></div>
        </div>
        
        <!-- 2_1 Chords - Color Matching Activity -->
        <div x-show="mode === '2_1_chords_color-matching'" class="chord-activity">
          
          <div class="chords-container">
            <h2 x-text="$store.strings?.chord_color_matching_title || 'Match Colors to Chords'">Match Colors to Chords</h2>
            
            <div class="color-matching-explanation">
              <p x-text="$store.strings?.chord_color_matching_intro || 'Listen to the chord and select the color that matches how it sounds to you.'">Listen to the chord and select the color that matches how it sounds to you.</p>
            </div>
            
            <div class="play-chord-button-container">
              <button @click="playChordByType(currentChordType); blurElement($event)" class="play-button">
                <span>🔈</span>
                <span x-text="$store.strings?.play_chord || 'Play Chord'">Play Chord</span>
              </button>
            </div>
            
            <div class="color-grid">
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#FFD700')" 
                   style="background-color: #FFD700;">
                <span>Major</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#4682B4')" 
                   style="background-color: #4682B4;">
                <span>Minor</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#DDA0DD')" 
                   style="background-color: #DDA0DD;">
                <span>Major 7</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#800080')" 
                   style="background-color: #800080;">
                <span>Diminished</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#FF4500')" 
                   style="background-color: #FF4500;">
                <span>Augmented</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#32CD32')" 
                   style="background-color: #32CD32;">
                <span>Sus4</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#00BFFF')" 
                   style="background-color: #00BFFF;">
                <span>Sus2</span>
              </div>
              <div class="color-option" 
                   @click="checkColorAnswer($data, '#FF6347')" 
                   style="background-color: #FF6347;">
                <span>Dom7</span>
              </div>
            </div>
            
            <!-- Individual feedback-message div removed - now using unified div -->
            
            <div class="score-display">
              <span x-text="`${correctAnswers} / ${totalQuestions}`"></span>
            </div>
          </div>
        </div>
        
        <!-- 2_2 Chords - Stable or Unstable Activity -->
        <div id="2_2_chords_stable_unstable" x-show="mode === '2_2_chords_stable_unstable'" class="chord-activity activity-container lazyload-bg" data-background-image="./images/backgrounds/2_2_chords_stable_unstable-1.jpg">
          
          <!-- Play buttons -->
          <div class="play-buttons-container-2_2">
            <!-- Start Game button (shown in free mode) -->
            <button id="start-game-2_2"
                    class="play-button_2_2" 
                    :title="$store.strings?.start_game || 'Start Game'">
              ▶️ Start Game
            </button>
            
            <!-- Replay button (shown in game mode) -->
            <button id="replay-button-2_2"
                    class="replay-button_2_2" 
                    :title="$store.strings?.replay_chord || 'Replay Chord'"
                    style="display: none;">
              🔄
            </button>
          </div>

          <div class="chords-container">            
            <!-- Progress display -->
            <div class="progress-display progress_2_2">
              <p x-text="($store.strings?.correct_answers_count || 'Correct answers: {0}').replace('{0}', progress['2_2'] || 0)"></p>
              <p x-show="(progress['2_2'] || 0) < 10" x-text="$store.strings?.stable_unstable_level1 || 'Can you hear the difference between stable and unstable chords?'"></p>
              <p x-show="(progress['2_2'] || 0) >= 10 && (progress['2_2'] || 0) < 20" x-text="$store.strings?.stable_unstable_level2 || 'Great job! Now listening for seventh chords and altered dominants! 🎵'"></p>
              <p x-show="(progress['2_2'] || 0) >= 20 && (progress['2_2'] || 0) < 30" x-text="$store.strings?.stable_unstable_level3 || 'Level 3: Extended harmonies vs. polytonal chords! 🎼'"></p>
              <p x-show="(progress['2_2'] || 0) >= 30 && (progress['2_2'] || 0) < 40" x-text="$store.strings?.stable_unstable_level4 || 'Level 4: Jazz voicings vs. atonal clusters! 🎹'"></p>
              <p x-show="(progress['2_2'] || 0) >= 40 && (progress['2_2'] || 0) < 50" x-text="$store.strings?.stable_unstable_level5 || 'Level 5: Impressionistic harmonies vs. microtonal variations! 🎶'"></p>
              <p x-show="(progress['2_2'] || 0) >= 50" x-text="$store.strings?.stable_unstable_level6 || 'Master Level: Complex extended harmonies and sophisticated dissonances! 🏆'"></p>
            </div>
            
            <div class="button_2_2_grid">
              <div id="button_2_2_stable" class="character activity-button-blocker" 
                   @click="checkStableUnstableMatch('stable', $data); blurElement($event)"
                   @touchstart.prevent
                   @touchend.prevent="$el.click();">
                <div title="Stable"></div>
              </div>
              
              <div id="button_2_2_unstable" class="character activity-button-blocker" 
                   @click="checkStableUnstableMatch('unstable', $data); blurElement($event)"
                   @touchstart.prevent
                   @touchend.prevent="$el.click();">
                <div title="Unstable"></div>
              </div>
            </div>
            
            <div class="feedback-message" x-show="showStableUnstableFeedback" x-text="stableUnstableFeedback" :class="{'correct': $data.stableUnstableCorrect !== undefined ? $data.stableUnstableCorrect : false, 'incorrect': $data.stableUnstableCorrect !== undefined ? !$data.stableUnstableCorrect : false}"></div>
          </div>
        </div>
        
        <!-- 2_3 Chords - Chord Building Activity -->
        <div x-show="mode === '2_3_chords_chord-building'" class="chord-activity">
          
          <div class="chords-container">
            <h2 x-text="$store.strings?.chord_building_title || 'Build Your Own Chords'">Build Your Own Chords</h2>
            
            <div class="chord-building-explanation">
              <p x-text="$store.strings?.chord_building_intro || 'Stack blocks to build different chords. Add each note to hear how the chord changes!'">Stack blocks to build different chords. Add each note to hear how the chord changes!</p>
            </div>
            
            <div class="chord-building-area">
              <div class="chord-blocks">
                <!-- Blocks will be added here as notes are selected -->
              </div>
              
              <div class="note-selector">
                <button @click="addNoteToChord(0); blurElement($event)" class="note-button">Root</button>
                <button @click="addNoteToChord(3); blurElement($event)" class="note-button">Minor 3rd</button>
                <button @click="addNoteToChord(4)" class="note-button">Major 3rd</button>
                <button @click="addNoteToChord(7)" class="note-button">Perfect 5th</button>
                <button @click="addNoteToChord(6)" class="note-button">Diminished 5th</button>
                <button @click="addNoteToChord(8)" class="note-button">Augmented 5th</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 2_4 Chords - Missing Note Activity -->
        <div x-show="mode === '2_4_chords_missing-note'" class="chord-activity">
          
          <div class="chords-container">
            <h2 x-text="$store.strings?.missing_note_title || 'Find the Missing Note'">Find the Missing Note</h2>
            
            <div class="missing-note-explanation">
              <p x-text="$store.strings?.missing_note_intro || 'Listen to the incomplete chord and select which note is missing.'">Listen to the incomplete chord and select which note is missing.</p>
            </div>
            
            <div class="play-chord-button-container">
              <button @click="playIncompleteChord()" class="play-button">
                <span>🔈</span>
                <span x-text="$store.strings?.play_incomplete_chord || 'Play Incomplete Chord'">Play Incomplete Chord</span>
              </button>
            </div>
            
            <div class="note-options">
              <button @click="checkMissingNote(3)" class="note-option-button activity-button-blocker">Minor 3rd</button>
              <button @click="checkMissingNote(4)" class="note-option-button activity-button-blocker">Major 3rd</button>
              <button @click="checkMissingNote(7)" class="note-option-button activity-button-blocker">Perfect 5th</button>
              <button @click="checkMissingNote(6)" class="note-option-button activity-button-blocker">Diminished 5th</button>
            </div>
            
            <!-- Individual feedback-message div removed - now using unified div -->
          </div>
        </div>
        
        <!-- 2_5 Chords - Character Matching Activity -->
        <div id="2_5_chords_characters" x-show="mode === '2_5_chords_characters'" class="chord-activity activity-container lazyload-bg" data-background-image="./images/backgrounds/2_5_chords_dog_cat_owl_no_squirrel_no_octopus.jpg">
          
          <!-- start-button, shown in free play mode -->
          <button id="start-game-mode-2_5" @click="start2_5GameMode(); $event.stopPropagation();" @touchstart.prevent @touchend.prevent="$el.click();" class="play-button" x-show="is2_5FreePlayMode" style="font-size: 2em; cursor: pointer;" :title="$store.strings?.start_game || 'Start Game Mode'">🦉</button>
          
          <!-- Play button (shown in game mode) -->
          <button id="play-chord-2_5" @click="playCurrent2_5Chord()" @touchstart.prevent @touchend.prevent="$el.click();" class="play-button" x-show="!is2_5FreePlayMode" :title="$store.strings?.play_chord || 'Play Chord'">▶️</button>

          <div class="chords-container">            
            <!-- Progress display -->
            <div class="progress-display progress_2_5">
              <p x-text="($store.strings?.correct_answers_count || 'Correct answers: {0}').replace('{0}', progress['2_5'] || 0)"></p>
              <p x-show="(progress['2_5'] || 0) < 10" x-text="$store.strings?.unlock_squirrel_message || 'Get 10 correct to unlock the squirrel! 🐿️'"></p>
              <p x-show="(progress['2_5'] || 0) >= 10 && (progress['2_5'] || 0) < 20" x-text="$store.strings?.unlock_octopus_message || 'Get 20 correct to unlock the octopus! 🐙'"></p>
              <p x-show="(progress['2_5'] || 0) >= 20 && (progress['2_5'] || 0) < 30" x-text="$store.strings?.all_animals_unlocked || 'All animals unlocked! 🎉'"></p>
              <p x-show="(progress['2_5'] || 0) >= 30 && (progress['2_5'] || 0) < 40" x-text="$store.strings?.transpose_challenge || 'Listen carefully! Chords are now changing pitch! 🎵'"></p>
              <p x-show="(progress['2_5'] || 0) >= 40 && (progress['2_5'] || 0) < 50" x-text="$store.strings?.squirrel_returns || 'The squirrel is back to help! Octopus still sleeping. 🐿️'"></p>
              <p x-show="(progress['2_5'] || 0) >= 50 && (progress['2_5'] || 0) < 60" x-text="$store.strings?.all_friends_return || 'All friends are back to help you! 🐿️🐙🐶🐱'"></p>
              <p x-show="(progress['2_5'] || 0) >= 60" x-text="$store.strings?.chords_2_5_master || 'You are Chords Master! 🎉'"></p>
            </div>
            
            
            <div class="character-grid">
              <div id="button_2_5_1_major" class="character activity-button-blocker" @click="checkCharacterMatch('major')" @touchstart.prevent @touchend.prevent="$el.click();">
                <div title="Happy">Happy</div>
              </div>
              
              <div id="button_2_5_1_minor" class="character activity-button-blocker" @click="checkCharacterMatch('minor')" @touchstart.prevent @touchend.prevent="$el.click();">
                <div title="Sad">Sad</div>
              </div>
              
              <div id="button_2_5_1_augmented" @click="checkCharacterMatch('augmented')" :class="(progress['2_5'] || 0) >= 10 && (progress['2_5'] || 0) < 20 ? 'character progress2 activity-button-blocker' : 'character activity-button-blocker'" @touchstart.prevent @touchend.prevent="$el.click();">
                <div title="Surprised">Surprised</div>
              </div>
              
              <div id="button_2_5_1_diminished" class="character activity-button-blocker" @click="checkCharacterMatch('diminished')" @touchstart.prevent @touchend.prevent="$el.click();">
                <div title="Mysterious">Mysterious</div>
              </div>
            </div>
            
            <!-- Individual feedback-message div removed - now using unified div -->
          </div>
        </div>
        
        <!-- 2_6 Chords - Harmony Gardens Activity -->
        <div x-show="mode === '2_6_chords_harmony-gardens'" class="chord-activity">
          
          <div class="chords-container">
            <h2 x-text="$store.strings?.harmony_gardens_title || 'Harmony Gardens'">Harmony Gardens</h2>
            
            <div class="harmony-gardens-explanation">
              <p x-text="$store.strings?.harmony_gardens_intro || 'Create a beautiful garden by choosing different chord sequences. Each chord type grows different plants!'">Create a beautiful garden by choosing different chord sequences. Each chord type grows different plants!</p>
            </div>
            
            <div class="garden-viewer">
              <div class="garden-canvas">
                <!-- Garden elements will be added here -->
              </div>
            </div>
            
            <div class="chord-sequence">
              <div class="chord-slot" @click="selectChordSlot(0)">
                <div class="chord-placeholder">+</div>
              </div>
              <div class="chord-slot" @click="selectChordSlot(1)">
                <div class="chord-placeholder">+</div>
              </div>
              <div class="chord-slot" @click="selectChordSlot(2)">
                <div class="chord-placeholder">+</div>
              </div>
              <div class="chord-slot" @click="selectChordSlot(3)">
                <div class="chord-placeholder">+</div>
              </div>
            </div>
            
            <div class="chord-palette">
              <button @click="plantChordInGarden('major')" class="chord-button activity-button-blocker">
                <span>🌻</span>
                <span>Major</span>
              </button>
              
              <button @click="plantChordInGarden('minor')" class="chord-button activity-button-blocker">
                <span>🌷</span>
                <span>Minor</span>
              </button>
              
              <button @click="plantChordInGarden('diminished')" class="chord-button activity-button-blocker">
                <span>🌵</span>
                <span>Diminished</span>
              </button>
              
              <button @click="plantChordInGarden('augmented')" class="chord-button activity-button-blocker">
                <span>🌺</span>
                <span>Augmented</span>
              </button>
            </div>
            
            <div class="play-sequence-container">
              <button @click="playChordSequence()" class="play-button">
                <span>🔈</span>
                <span x-text="$store.strings?.play_sequence || 'Play Sequence'">Play Sequence</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Chapter: Free Play -->
    <section class="chapters-view" x-show="active === 'freeplay'" x-transition>
      <h2>Free Play Mode</h2>
      <p>Coming soon!</p>
    </section>
    
    <!-- Legal: Impressum & Datenschutz - included from partials/impress.html -->
    <div data-include="partials/impress_privacy.html"></div>
    
    <!-- Legal: Credits - included from partials/credits.html -->
    <div data-include="partials/credits.html">
      <!-- Vorübergehende Fallback-Version bis das Partial geladen wird -->
      <section x-show="active === 'credits' && (window.innerWidth >= 1024 || !menuOpen)" x-transition>
        <h2 x-text="$store.strings?.credits_header || 'Credits'"></h2>
        <div class="legal-content">
          <h3 x-text="$store.strings?.version_label || 'Version'"></h3>
          <p id="app-version">Version 2.1 (21)</p>
        </div>
      </section>
    </div>
    
    <!-- Referral Code Page - included from partials/referrals.html -->
    <div data-include="partials/referrals.html"></div>
    
    <!-- Settings Page - included from partials/settings.html -->
    <div data-include="partials/settings.html"></div>
               

    <!-- Unified Feedback Message Container -->
    <div class="feedback-message" id="unified-feedback-message" x-show="$store.feedback.showFeedback">
      <p x-text="$store.feedback.feedbackMessage"></p>
    </div>
    
    <!-- Global footer for all activities with an invers edge
    <div class="bottom_round_edge">
      <div class="footer_inner"></div>
    </div>-->

  </main>

<script>
  // Cross-platform blur helper for removing focus on touch/click events with a 1 second delay
  // This works on both web and Android platforms
  window.blurElement = function(event) {
    // Get the target element
    const target = event.currentTarget || event.target;
    console.log('[BLUR] Will blur element after 1 second delay:', target && target.tagName, target && target.className);
    
    // Let the focus stay for 1 second, then remove it
    setTimeout(() => {
      console.log('[BLUR] Now removing focus after delay, active element:', document.activeElement && document.activeElement.tagName);
      
      // Blur the element
      if (target && typeof target.blur === 'function') {
        console.log('[BLUR] Calling blur() on target');
        target.blur();
      } else {
        console.log('[BLUR] Could not call blur() on target:', target);
      }
      
      // Remove focus from active element as well
      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        console.log('[BLUR] Calling blur() on document.activeElement:', document.activeElement.tagName);
        document.activeElement.blur();
      } else {
        console.log('[BLUR] Could not call blur() on document.activeElement:', document.activeElement);
      }
      
      // On Android, we need to ensure focus is removed from the element
      // This helps with removing the box shadow/focus ring that persists on touch devices
      if (target && target.classList) {
        console.log('[BLUR] Permanently removing focus styles to prevent them from reappearing');
        
        // Check if this is the play button which has special styling
        const isPlayButton = target.classList.contains('circular-play-button');
        
        // For Android Chrome, we need to be more aggressive - reset all styles that could persist
        target.style.outline = 'none';
        target.style.boxShadow = 'none';
        target.style.webkitBoxShadow = 'none';
        target.style.webkitTapHighlightColor = 'transparent';
        
        // Special handling for play button - reset background color
        if (isPlayButton) {
          console.log('[BLUR] Resetting play button background color');
          // Reset to transparent background (original state)
          target.style.backgroundColor = 'transparent';
          // Reset transform as well
          target.style.transform = 'none';
        }
        
        // Apply these styles to prevent refocus
        target.setAttribute('tabindex', '-1');
        
        // Force a repaint/reflow to ensure changes take effect
        target.offsetHeight; // Trigger reflow
        
        console.log('[BLUR] Completed blur sequence with permanent style changes');
        
        // Add an event listener to prevent refocusing
        const preventRefocus = function(e) {
          e.preventDefault();
          target.blur();
          
          // For play button, ensure background color stays reset
          if (isPlayButton) {
            target.style.backgroundColor = 'transparent';
          }
          
          console.log('[BLUR] Prevented refocus attempt');
          // Remove after handling once
          target.removeEventListener('focus', preventRefocus);
        };
        target.addEventListener('focus', preventRefocus, { once: true });
      }
    }, 1000); // 1 second delay before blurring
  };
</script>

<script>
  // Update environment classes after Alpine.js is initialized
  function updateEnvironmentClasses() {
    const body = document.body;
    
    // Remove any existing environment classes
    body.classList.remove('native-app', 'web-app', 'android', 'ios', 'desktop', 'dev', 'production');
    
    // Add current environment classes
    body.classList.add(
      window.isNativeApp ? 'native-app' : 'web-app',
      window.isAndroid ? 'android' : (window.isiOS ? 'ios' : 'desktop'),
      window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'dev' : 'production'
    );
  }
  
  // Globale Funktionen für Lazy Loading, Back-Button-Handling und Menü-Interaktion
  
  // Funktion zum automatischen Schließen des Menüs, wenn genau ein normales Menüitem verfügbar ist
  function checkAndAutoCloseMenu() {
    console.log('[DEBUG] Checking if menu should auto-close');
    // Gib dem DOM Zeit, sich zu aktualisieren
    setTimeout(() => {
      // Zähle normale (nicht debug-element) Buttons in den menu-activities
      const normalItems = document.querySelectorAll('.menu-activities button:not(.debug-element):not([disabled])');
      // Zähle debug-element Buttons
      const debugItems = document.querySelectorAll('.menu-activities button.debug-element:not([disabled])');
      // Zähle alle aktivierbaren Buttons
      const allItems = document.querySelectorAll('.menu-activities button:not([disabled])');
      
      console.log(`[DEBUG] Found ${normalItems.length} normal and ${debugItems.length} debug menu items (total: ${allItems.length})`);
      
      // Wenn genau ein normales Item vorhanden ist, klicke es automatisch (unabhängig von Debug-Items)
      if (normalItems.length === 1) {
        console.log('[DEBUG] Auto-clicking the only normal menu item');
        normalItems[0].click();
      }
      // Wenn keine normalen Items, aber genau ein Debug-Item vorhanden ist, klicke es automatisch
      else if (normalItems.length === 0 && debugItems.length === 1) {
        console.log('[DEBUG] No normal items found. Auto-clicking the only debug menu item');
        debugItems[0].click();
      }
    }, 50);
  }
  
  function initLazyLoading() {
    // Initial alle Lazy-Load-Elemente laden
    loadBackgroundImages();

    // Beobachter erstellen, der neue Elemente überprüft
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          loadBackgroundImages();
        }
        
        if (mutation.addedNodes.length) {
          loadBackgroundImages();
        }
      });
    });

    // Beobachter auf den Container anwenden
    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['style', 'x-show']
    });

    // Handler für Browser-Back-Button einrichten
    setupBackButtonHandler();
  }

  // Lädt Hintergrundbilder für sichtbare Elemente
  function loadBackgroundImages() {
    document.querySelectorAll('.lazyload-bg').forEach(element => {
      // Überprüfen, ob das Element sichtbar ist
      const rect = element.getBoundingClientRect();
      const isVisible = (
        rect.top <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.bottom >= 0 &&
        rect.left <= (window.innerWidth || document.documentElement.clientWidth) &&
        rect.right >= 0 &&
        window.getComputedStyle(element).display !== 'none'
      );

      if (isVisible && element.dataset.backgroundImage) {
        // Nur laden, wenn das Element sichtbar ist und noch kein Hintergrundbild hat
        if (!element.style.backgroundImage || element.style.backgroundImage === 'none') {
          element.style.backgroundImage = `url('${element.dataset.backgroundImage}')`;
        }
      }
    });
  }

  // Behandlung des Browser-Back-Buttons
  function setupBackButtonHandler() {
    // Erkennen der Plattform
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    // Definitionen für verschiedene Back-Button-Verhalten
    let currentConfirmMessage = 'Attention! Do you really want to leave this page?';
    
    // String-Aktualisierungsfunktion - wird aufgerufen, wenn Alpine.store aktualisiert wird
    function updateBackButtonStrings() {
      // Aktualisiere die lokale Nachrichtenvariable aus dem Store
      if (Alpine.store('strings')?.back_button_confirm_exit) {
        currentConfirmMessage = Alpine.store('strings').back_button_confirm_exit;
        console.log('Updated back button confirm message: ' + currentConfirmMessage);
      }
    }
    
    // Initial versuchen, Strings zu laden
    updateBackButtonStrings();
    
    // Event-Listener für Store-Änderungen (wird ausgelöst, sobald Strings geladen sind)
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Alpine.js
      Alpine.start();
      
      // Load and display version number
      loadVersion();
    });

    async function loadVersion() {
      try {
        // Load package.json - angepasster Pfad für app/-Unterordner
        const response = await fetch('../package.json');
        if (!response.ok) {
          throw new Error(`Failed to fetch package.json: ${response.status}`);
        }
        const packageJson = await response.json();
        const version = packageJson.version;
        const versionCode = packageJson.versionCode;
        console.log('Version loaded:', version, versionCode);
        
        // Display version in credits section
        const versionElement = document.getElementById('app-version');
        if (versionElement) {
          versionElement.textContent = `Version ${version} (${versionCode})`;
        }
      } catch (error) {
        console.error('Error loading version:', error);
      }
    }

    // Event-Listener für Store-Änderungen (wird ausgelöst, sobald Strings geladen sind)
    document.addEventListener('alpine:initialized', function() {
      if (window.Alpine && window.Alpine.effect) {
        window.Alpine.effect(() => {
          // Diese Funktion wird automatisch aufgerufen, wenn sich Alpine.store('strings') ändert
          updateBackButtonStrings();
        });
      }
    });
    
    // Behandlung für Browser-History (web)
    window.addEventListener('popstate', function(event) {
      // Testen, ob wir in einer App sind oder im Browser
      if (isAndroid) {
        // In Android: Zurück zum Menü, wenn nicht gesperrt , TODO: select by 'id="app"' instead
        const app = Alpine.getScope(document.querySelector('[x-data="app()"]'));
        if (app && !app.menuLocked) {
          // Wenn nicht im Hauptmenü, zurück zum Hauptmenü gehen
          if (app.active !== 'main') {
            app.setActive('main');
            // Verhindern des Verlassens der App
            history.pushState(null, null, window.location.pathname);
            event.preventDefault();
          }
        }
      } else {
        // Im Browser: Nachfragen, ob die Seite wirklich verlassen werden soll
        // Verwende die aktualisierte Nachrichtenvariable
        if (confirm(currentConfirmMessage)) {
          // Benutzer will die Seite verlassen -> nichts tun
        } else {
          // Benutzer will auf der Seite bleiben -> Zustand wiederherstellen
          history.pushState(null, null, window.location.pathname);
          event.preventDefault();
        }
      }
    });

    // Verhindert, dass der Benutzer die Seite verlässt, indem wir einen History-Eintrag hinzufügen
    history.pushState(null, null, window.location.pathname);
  }
</script>
</body>
</html>
